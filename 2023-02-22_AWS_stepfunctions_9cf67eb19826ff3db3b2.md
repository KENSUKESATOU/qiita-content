<!--
title:   AWS Hands-on for Beginners AWS Step Functions 入門 - ビジュアルツールを使ってローコードにワークフローを作成する：学習メモ
tags:    AWS,stepfunctions,ハンズオン
id:      9cf67eb19826ff3db3b2
private: false
-->
## はじめに

AWSハンズオン for Beginnersシリーズとして提供されている「[Step Functions 入門 - ビジュアルツールを使ってローコードにワークフローを作成する](https://pages.awscloud.com/JAPAN-event-OE-Hands-on-for-Beginners-StepFunctions-2022-reg-event.html?trk=aws_introduction_page)」を実施した際のメモです。[前回の記事](2023-02-20_AWS_stepfunctions_48176578c1195f21f91d.md)でもStep Functionsに関するハンズオンを記載しました。そこではStep Functionと**Lambdaと連携**したり、**エラーハンドリング**、**Mapステート**を使用してステートマシンの連続実行などを体験することができました。今回のハンズオンでは前回使用しなかった機能(**Choiceステート, Parallelステート, Waitステート, 入出力の受け渡し**)を使ってより実践的なアプリケーションを作成します。

なお、「Step Functionsとは何か」「使用するとどんなメリットがあるか」「ユースケースは何か」についての説明は[前回の記事](2023-02-20_AWS_stepfunctions_48176578c1195f21f91d.md)をご覧ください。

## アジェンダ

1. 今回のハンズオンのシナリオ/構成の紹介 + AWS Step Functions の基本
2. ステートマシーンの作成 + 「アクション」を使ってみる
3. Input の受け取り + Choice ステートを使ってみる
4. Parallel ステートで処理を並列に実行する
5. Output の調整 + DB（Amazon DynamoDB）の更新
6. Parallel ステートのもう一方の実装 - テキストを音声化する
7. ステートで「タスクが終わるまで待つ」を実装する
8. 音声ファイルの出力先情報を DynamoDB テーブルに格納する
9. リソースの削除 + まとめ + Next Action 案

## はまったところ

**2.ステートマシーンの作成+「アクション」を使ってみる**で、APIパラメータ作成時「**Parameters.Key.Key : Value is mandatory.**」というエラーダイアログが表示され、エラーの修正をするか、そのまま続行するか聞かれました。

https://twitter.com/ksatou34276097/status/1562099391275880451?s=20&t=uUbnL7lxE2IOAYzf6-hQAA

APIパラメータに指定したJsonはデフォルトで入力されていたものです。また、ハンズオンで入力するものに変更しても同様の現象が発生しました。原因はわかりませんでしたが、以下のツイート内容の通り、エラーを無視して続行できるため、気にしないようにしました。

https://twitter.com/ksatou34276097/status/1562100093138120705?s=20&t=uUbnL7lxE2IOAYzf6-hQAA

## メモ

### APIパラメータ可変項目の参照指定

入力Jsonのキーに対応する値をステートマシンのアクションで使用したい場合、APIパラメータの値に「**$.**」をつけ、入力Jsonに対応するパスを指定します。また、Jsonパスを指定する場合、キー名の後ろに「**.$**」をつける必要もあります。例えば、ステートの入力となるJsonが **{"ArticleID":"0001"}** で、DynamoDBのGetItemアクションで入力の **"0001"** を使用する場合、APIパラメータは以下のように記述します。

```json
{
	"TableName": "Article",
	"Key": {
		"ArticleID": {
			"S.$": "$.ArticleID"
		}
	}
}
```

## ステート間で情報を共有する

ステート間で情報を共有する機能があります。例えば、アクションが2つ連続しているステートマシンがあり、1つ目のアクションのステップ入力を2つ目のアクションで参照したい時に使用します。アクションのステップ入力となったJsonをステップ出力に含めることができます。（アクションで「出力」を選択し、**Combine original input with result**を選択。出力Jsonを内包するキー名を入力する）

## Waitステートについて

本ハンズオンではテキスト読み上げ(音声化)サービスであるAmazon Pollyを使用します。Pollyの音声化は**非同期**に行われるため、Pollyが入力テキストを音声ファイルに変換する処理が完了する前に、ステートマシンが終了してしまう可能性があります。本ハンズオンではこの問題への対応として**Waitステート**を使用しています。Pollyの処理は音声化リクエスト毎に管理されており、処理の状態をステータスで表しています。例えば、処理中であればscheduled、処理が完了したらcompletedなどです。**Waitステート**でこのステータスを監視し、completedでなければ、指定したステートを再実行させるという設定が簡単にできます。

## ハンズオンの感想

AWSサービスを複数、並列に実行して結果を取得するという少し複雑なアプリケーションをGUI上で簡単に作成することができました。APIパラメータのJsonの書き方やステート間の情報共有機能については慣れる必要がありますが、意外に楽にできたのは驚きました。[前回](2023-02-20_AWS_stepfunctions_48176578c1195f21f91d.md)と今回のハンズオンでStep Functionsの機能をほとんど体験することができましたが、Lambdaとの連携がまだしっくりきていません。これについては本ハンズオンで紹介されていた別のハンズオンで腹落ちさせようと思います。